<!DOCTYPE html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

  <style>
  .body {
    background-color: #F5F5DC;
  }
  .tract {
    
  }
  .selected {
    fill: #FF7F50;
  }
  .tract:hover {
    fill: #FF7F50;
  }
  .circle {
    fill: #F7FE2E;
    margin-left: 10px;
  }
  .circle-text {
    background-color: #F2F5A9;
  }
  .circle:hover {
    fill: #FF7F50;
  }
  .circle2 {
    fill: #58FA58;
  }
  .circle2-text {
    background-color: #BCF5A9;
  }
  .circle2:hover {
     fill: #FF7F50;
  }
  .info {
    margin-top: 20px;
  }
  #image {
  	width: 200px;
  	height: 100px;
  }
  #zone-name {
    margin-top:10px;
    margin-bottom:10px;
  }
  #time-line {
    margin-right: 30px;
    margin-left: 30px;
  }
  #zone-pm {
    margin-top: 20px;
    margin-bottom: 10px;
  }
  </style>


  <title>LUTI-VIZA</title>

</head>
<body>
  <div class="container">
    <div class="row">
      <div class="col-md-8">
        <div class="info">
          <h3>¿Cómo se comporta la distribución del CO2 y el Material Particulado(PM) 
          en las diferentes zonas en Bogotá?</h3>
          <p>A continuación se muestra el mapa de Bogotá dividido por barrios, al oprimir sobre uno de estos
            se puede observar graficamente la distribución del CO2 y del Material Particulado en dicha zona en diferentes periodos de tiempo(años). El dato de la distribucción se visualiza ubicando el mouse sobre la barra deseada.
            <!--También se puede escribir el nombre del barrio en la barra de busqueda.--> </p>
            <p>Fuente mapa de Bogotá:( <a href="https://movement.uber.com/explore/bogota/travel-times/query?ag=cadastral&cd=&dt%5Bdr%5D%5Bed%5D=2018-01-31&dt%5Bdr%5D%5Bsd%5D=2018-01-01&dt%5Btpb%5D=ALL_DAY&dt%5Bwd%3B%5D=1%2C2%2C3%2C4%2C5%2C6%2C7&lang=es-CO&lat.=4.598056&lng.=-74.075833&sa%3B=&sdn=&si=183&ti=&z.=12">Uber Movements Bogota</a>). Los datos de la distribución del CO2 y del Material Particulado que se muestran están dados a manera de ejemplo(Pendiente contar con los datos reales).
            </p>
            <div class="row">
              <div class="col-4">
                <select id="mySelect" class="form-control" name="select">
                  <option value="co2" selected>Dioxido de carbono</option>
                  <option value="pm">Material Particulado</option>
                </select>
                <!--<input id="searchInput" class="form-control" type="text" name="zone" placeholder="Buscar por nombre">-->
              </div>
              <div class="col-6">
                <div class="row border" style="height: 20px;">
                  <div id="color-scale" class="col"></div>
                  <div id="color-scale" class="col"></div>
                  <div id="color-scale" class="col"></div>
                  <div id="color-scale" class="col"></div>
                  <div id="color-scale" class="col"></div>
                </div>
                <div class="row" style="height: 20px;">
                  <div class="col">100</div>
                  <div class="col">200</div>
                  <div class="col">300</div>
                  <div class="col">400</div>
                  <div class="col">500</div>
                </div>
              </div>
            <div class="col-2">
              <div id="measure">PPM</div>
            </div>    
            <div id="zone-name"></div>
            <div>
              <div id="zone-co2"></div>
              <svg id="co2Circles" width="720" height="120"></svg>
              <span id="time-line"></span>
              <span id="time-line"></span>
              <span id="time-line"></span>
              <span id="time-line"></span>
              <span id="time-line"></span>
              <span id="time-line"></span>
              <span id="time-line"></span>
            </div>
            <div>
              <div id="zone-pm"></div>
              <svg id="pmCircles" width="720" height="120"></svg>
              <span id="time-line"></span>
              <span id="time-line"></span>
              <span id="time-line"></span>
              <span id="time-line"></span>
              <span id="time-line"></span>
              <span id="time-line"></span>
              <span id="time-line"></span>
            </div>
        </div>
      </div>
    </div>
      <div class="col-md-4">
        <div class="info">
          <!-- MAP CONTAINER -->
          <svg id="map"></svg>
        </div>
      </div>
    </div>
  </div>

  
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
  <!-- Define inlined PaperScript associate it with myCanvas -->
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script>

    

  var svg = d3.select("#map");
  const width = 400;
  const height = 600;
  const margin = { top: 100, bottom:20, right: 10, left: 10};
  const ul = d3.select("#zone-name");
  const co2 = d3.select("#zone-co2");
  const pm = d3.select("#zone-pm");
  const rangeSelector = d3.select("#range-selector");
  const year = d3.select("#year");
  let currenValue = "co2";
  let last;
  let changed = false;

  const path = d3.geoPath();
  var projection = d3.geoTransverseMercator();

  let csvData = [];
  d3.csv("data.csv", function(d) {
  return {
    color: d.Color,
    year1: d.Year1,
    year2: d.Year2,
    year3: d.Year3,
    year4: d.Year4,
    year5: d.Year5,
    year6: d.Year6,
    year7: d.Year7
  };
    }, function(error, rows) {
      console.log(rows[0]);
      for(let i of rows){
        csvData.push(i);
      }
    });

  let csvData2 = [];
  d3.csv("data2.csv", function(d) {
  return {
    color: d.Color,
    year1: d.Year1,
    year2: d.Year2,
    year3: d.Year3,
    year4: d.Year4,
    year5: d.Year5,
    year6: d.Year6,
    year7: d.Year7
  };
    }, function(error, rows) {
      console.log(rows[0]);
      for(let i of rows){
        csvData2.push(i);
      }
    });
  const colors1 = ["#F2F5A9","#F3F781","#F4FA58","#F7FE2E","#AEB404"];
  const colors2 = ["#D8F6CE","#81F79F","#58FA58","#04B45F","#088A29"];

  let colorScale = d3.selectAll("#color-scale")._groups[0];
  let measure = d3.select("#measure");

  function changeMeasure(variable){
    if(variable==="co2"){
      measure.html("PPM");
    } else {
      measure.html("Micrómetros");
    }
  }

  function colorScaleFunction(variable){
      for(let i = 0; i < colorScale.length; i++){
        if(variable==="co2"){
          colorScale[i].style.background = colors1[i];
        } else {
          colorScale[i].style.background = colors2[i];
        }   
    }
  }
  
  colorScaleFunction("co2");

  d3.json("bogota_cadastral.json", function(error, data) {
    if (error) throw error;

    svg.style("width",width);
    svg.style("height",height);
  
    path.projection(projection.rotate([0,0,8]));
    path.projection(projection.fitSize([width, height], data));
    

    function co2Config(){ svg.selectAll("path")
      .data(data.features)
      .enter().append("path")
        .attr("class", "tract")
        .attr("fill",function(d){
          return csvData[d.properties.MOVEMENT_ID].color;
        })
        .on("mouseover", function(){
          d3.select(this).attr("fill","#FF7F50");
        })
        .on("mouseout", function() {
          d3.select(this).attr("fill",function(d){
          return csvData[d.properties.MOVEMENT_ID].color;
        });
        })
        .attr("d", path)  
      .append("title")
        .text(function(d) { 
         return d.properties.scanombre;
          }); 

        svg.selectAll(".tract-border")
      .data(data.features)
      .enter()
      .append("path")
      .style("fill","none")
      .style("stroke","#528B8B")
        .attr("d", path);
      }


    co2Config();
    document.getElementById('mySelect').addEventListener('change', warn, true);
    function warn(e) {
      e.preventDefault();
      e.stopPropagation();
      currenValue = e.currentTarget.value;
      changeColor(currenValue);
      colorScaleFunction(currenValue);
      changeMeasure(currenValue);
    }

    

    svg.selectAll("path").on("click", function(d){
        ul.html("<h3>"+ d.properties.scanombre + "</h3>");
        
        if(last!==undefined){
          if(currenValue === "co2"){
            last.style("fill", csvData[d.properties.MOVEMENT_ID].color);
          } else {
            last.style("fill", csvData2[d.properties.MOVEMENT_ID].color);
          }
          last.on("mouseout", function(d){
          if(currenValue === "co2"){
            d3.select(this).style("fill", csvData[d.properties.MOVEMENT_ID].color);
          } else {
            d3.select(this).style("fill", csvData2[d.properties.MOVEMENT_ID].color);
          }   
    }); 
        }

        d3.select(this).on("mouseout", function(){});
        last = d3.select(this);
        d3.select(this).style("fill","#FF7F50");
        

        let timeLine = document.querySelectorAll("#time-line");
        let y = 2000;
        for(let i of timeLine){
          i.innerHTML ="<em>" + y + "</em>";
          y+= 10;
          if(y > 2060){ y = 2000};
        }
        co2.html("<h6 class='circle-text'>CO2<em>(Particulas Por Millón/Año)</em></h6>");
        pm.html("<h6 class='circle2-text'>PM<em>(Micrómetros/Año)</em></h6>");
        let svgCircles = d3.select("#co2Circles");
        if(svgCircles.html().trim() !== ""){
          svgCircles.html(" ");
        }
        



        let svgCirclesPM = d3.select("#pmCircles");
        if(svgCirclesPM.html().trim() !== ""){
          svgCirclesPM.html(" ");
        }
         
        let dataFromTheGraph = [parseInt(csvData[this.__data__.properties.MOVEMENT_ID].year1),
          parseInt(csvData[this.__data__.properties.MOVEMENT_ID].year2),
          parseInt(csvData[this.__data__.properties.MOVEMENT_ID].year3),
          parseInt(csvData[this.__data__.properties.MOVEMENT_ID].year4),
          parseInt(csvData[this.__data__.properties.MOVEMENT_ID].year5),
          parseInt(csvData[this.__data__.properties.MOVEMENT_ID].year6),
          parseInt(csvData[this.__data__.properties.MOVEMENT_ID].year7)];

        let dataFromTheGraph2 = [parseInt(csvData2[this.__data__.properties.MOVEMENT_ID].year1),
          parseInt(csvData2[this.__data__.properties.MOVEMENT_ID].year2),
          parseInt(csvData2[this.__data__.properties.MOVEMENT_ID].year3),
          parseInt(csvData2[this.__data__.properties.MOVEMENT_ID].year4),
          parseInt(csvData2[this.__data__.properties.MOVEMENT_ID].year5),
          parseInt(csvData2[this.__data__.properties.MOVEMENT_ID].year6),
          parseInt(csvData2[this.__data__.properties.MOVEMENT_ID].year7)];

        var circle = svgCircles.selectAll("rect")
            .data(dataFromTheGraph)
            .enter().append("rect")
              .attr("y", function(d){return (100-(d/4))})
              .attr("x", function(d, i) { return i * 100 + 30; })
              .attr("width", 30)
              .attr("height", function(d) { return d/4; })
              .attr("class", "circle")
            .append("title")
              .text(function(d) { 
               return d + " Particulas Por Millón";
                });
        var circle2 = svgCirclesPM.selectAll("rect")
            .data(dataFromTheGraph2 )
            .enter().append("rect")
              .attr("y", function(d){return (100-(d/4))})
              .attr("x", function(d, i) { return i * 100 + 30; })
              .attr("width", 30)
              .attr("height", function(d) { return d/4; })
              .attr("class", "circle2")
            .append("title")
              .text(function(d) { 
               return d + " Micrómetros";
                });


      });      

    svg.selectAll("path").on("mouseover", function(){
          d3.select(this).style("fill","#FF7F50");
    });

    svg.selectAll("path").on("mouseout", function(d){
          if(currenValue === "co2"){
            d3.select(this).style("fill", csvData[d.properties.MOVEMENT_ID].color);
          } else {
            d3.select(this).style("fill", csvData2[d.properties.MOVEMENT_ID].color);
          }   
    });

  
       

  var searchButton = document.querySelector("#searchButton");
  var searchInput = document.querySelector("#searchInput");
  var errorMessage = document.querySelector("#errorMessage");
  var svgPaths = svg.selectAll("path")._groups[0];

  function changeColor(variable){
    for(let i = 0; i < svgPaths.length; i ++){
      if(variable === "co2"){
        svgPaths[i].style.fill = csvData[svgPaths[i].__data__.properties.MOVEMENT_ID].color;
      } else {
        svgPaths[i].style.fill = csvData2[svgPaths[i].__data__.properties.MOVEMENT_ID].color;
      }
    }
  }

  /*
  searchButton.addEventListener("click",function(){
    svg.selectAll("path").attr("class","tract");  
    s = searchInput.value.toUpperCase();
    for(var i = 0; i < svgPaths.length; i ++){
     if(svgPaths[i].__data__.properties.scanombre == s)
     {
        console.log(svgPaths[i].__data__.properties.scanombre + "=" + searchInput.value);
        ul.html("<h3>"+ svgPaths[i].__data__.properties.scanombre + "</h3>");
        console.log(svgPaths[i].classList);
        svgPaths[i].classList.remove("tract");
        svgPaths[i].classList.add("selected");
        searchInput.value = "";
        
        if(last!==undefined){
          if(currenValue === "co2"){
            last.style.fill =  csvData[svgPaths[i].__data__.properties.MOVEMENT_ID].color;
          } else {
            last.style.fill =  csvData2[svgPaths[i].__data__.properties.MOVEMENT_ID].color;
          }
          last.addEventListener("mouseout", function(d){
          if(currenValue === "co2"){
              svgPaths[i].style.fill = csvData[svgPaths[i].__data__.properties.MOVEMENT_ID].color;
          } else {
              svgPaths[i].style.fill = csvData2[svgPaths[i].__data__.properties.MOVEMENT_ID].color;
          }   
    }); 
        }

        svgPaths[i].addEventListener("mouseout", function(){});
        last = svgPaths[i];
        svgPaths[i].style.fill = "#FF7F50";

        let timeLine = document.querySelectorAll("#time-line");
        let y = 2000;
        for(let i of timeLine){
          i.innerHTML ="<em>" + y + "</em>";
          y+= 10;
          if(y > 2060){ y = 2000};
        }
        co2.html("<h6 class='circle-text'>CO2<em>(Particulas Por Millón/Año)</em></h6>");
        pm.html("<h6 class='circle2-text'>PM<em>(Micrómetros/Año)</em></h6>");
        let svgCircles = d3.select("#co2Circles");
        if(svgCircles.html().trim() !== ""){
          svgCircles.html(" ");
        }
        



        let svgCirclesPM = d3.select("#pmCircles");
        if(svgCirclesPM.html().trim() !== ""){
          svgCirclesPM.html(" ");
        }
         
        let dataFromTheGraph = [parseInt(csvData[svgPaths[i].__data__.properties.MOVEMENT_ID].year1),
          parseInt(csvData[svgPaths[i].__data__.properties.MOVEMENT_ID].year2),
          parseInt(csvData[svgPaths[i].__data__.properties.MOVEMENT_ID].year3),
          parseInt(csvData[svgPaths[i].__data__.properties.MOVEMENT_ID].year4),
          parseInt(csvData[svgPaths[i].__data__.properties.MOVEMENT_ID].year5),
          parseInt(csvData[svgPaths[i].__data__.properties.MOVEMENT_ID].year6),
          parseInt(csvData[svgPaths[i].__data__.properties.MOVEMENT_ID].year7)];

        let dataFromTheGraph2 = [parseInt(csvData2[svgPaths[i].__data__.properties.MOVEMENT_ID].year1),
          parseInt(csvData2[svgPaths[i].__data__.properties.MOVEMENT_ID].year2),
          parseInt(csvData2[svgPaths[i].__data__.properties.MOVEMENT_ID].year3),
          parseInt(csvData2[svgPaths[i].__data__.properties.MOVEMENT_ID].year4),
          parseInt(csvData2[svgPaths[i].__data__.properties.MOVEMENT_ID].year5),
          parseInt(csvData2[svgPaths[i].__data__.properties.MOVEMENT_ID].year6),
          parseInt(csvData2[svgPaths[i].__data__.properties.MOVEMENT_ID].year7)];

        var circle = svgCircles.selectAll("rect")
            .data(dataFromTheGraph)
            .enter().append("rect")
              .attr("y", function(d){return (100-(d/4))})
              .attr("x", function(d, i) { return i * 100 + 30; })
              .attr("width", 30)
              .attr("height", function(d) { return d/4; })
              .attr("class", "circle")
            .append("title")
              .text(function(d) { 
               return d + " Particulas Por Millón";
                });
        var circle2 = svgCirclesPM.selectAll("rect")
            .data(dataFromTheGraph2 )
            .enter().append("rect")
              .attr("y", function(d){return (100-(d/4))})
              .attr("x", function(d, i) { return i * 100 + 30; })
              .attr("width", 30)
              .attr("height", function(d) { return d/4; })
              .attr("class", "circle2")
            .append("title")
              .text(function(d) { 
               return d + " Micrómetros";
                });
     } 
   }
  });
  */
    
  });

  
  
  </script>

</body>



